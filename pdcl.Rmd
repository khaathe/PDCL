---
title: "PDCL Process"
output:
  pdf_document: 
    fig_width: 10
    fig_height: 7
    highlight: kate
  html_notebook: 
    fig_width: 10
    fig_height: 7
    highlight: kate
    toc: yes
---

```{r, message=FALSE}
# clean workspace
rm(list=ls()) 

# Load required libraries (others are load directly in sourced files)
library(DESeq2)
library(dplyr)

# Source files with functions used in next steps
source("R/gprofiler-analysis.R")
source("R/gsea-analysis.R")
source("R/plot-result.R")
```

# 1. Differential Analysis with DESeq2

## Load controls

```{r load-controls}
control_file <- "Data/PDCL/astrocyte_GSE109001_counts_unique_genes_samples_filtered.txt"
control <- read.table(
  control_file, 
  header = T, 
  sep = "\t", 
  as.is = c("id", "symbol")
)
control_names <- c(
  "AF22_NES_Astro_Br1_d29_37_S46",
  "AF22_NES_Astro_Br2_d29_38_S56",
  "AF22_NES_Astro_Br3_d29_39_S66",
  "CCF.STTG1_p24_Br1_S16",
  "CCF.STTG1_p24_Br2_S17",
  "CCF.STTG1_p24_Br3_S18",
  "CDIAstrocytes_p2_Br1_S19",
  "CDIAstrocytes_p2_Br2_S20",
  "CDIAstrocytes_p2_Br3_S21",
  "phaAstrocyte_p2_Br1_S1",
  "phaAstrocyte_p2_Br2_S2",
  "phaAstrocyte_p2_Br3_S3"
  )
```

## Load PDCL DataBase

Load the PDCL count table. Disabled check.names otherwise it will add a X at the beginning of each column name, as column names aren't valid according to R.

```{r load-pdcl}
pdcl_count_table <- read.table(
  "/home/spinicck/PhD/Data/PDCL/lignees_count_genes_PDCL.txt", 
  sep = "\t", 
  header = T, 
  as.is = "gene_id", 
  check.names = F
)

pdcl_names <- c(
  "4339-p21",
  "4371-p37",
  "5706-p14",
  "6190-p43",
  "6240-p12",
  "7015-p17",
  "7060-p18", 
  "7142-p14",
  "N13-1300",
  "N13-1520-p9",
  "N14-0072",
  "N14-0870",
  "N14-1208",
  "N14-1525",
  "N15_0460",
  "N15_0516",
  "N15-0385",
  "N15-0661",
  "N16_0535",
  "N16-0240"
)
```

## Prepare Object needed by DESeq2 for Analysis

Create two data.frame:

-   count_data : contain the raw counts of each genes for both control and PDCL samples
-   count_metadata : metadata for associated with the samples to know which samples belong to the controls and which belong to the PDCL

```{r prepare-count-data}
# Merge control and PDCL counts into one dataframe
count_data <- merge(control, pdcl_count_table, by.x = "symbol", by.y = "gene_id")
# Associate each row with a gene symbol
row.names(count_data) <- count_data$symbol
# Remove symbol and id columns
count_data <- count_data %>% dplyr::select(!c(symbol, id))
condition_vect <- c(
  rep("control", length(control_names)), 
  rep("pdcl", length(pdcl_names))
)
count_metadata <- data.frame(
  sample = c(control_names, pdcl_names), 
  condition=condition_vect
)
count_metadata$condition <- as.factor(count_metadata$condition)
```

## Perform Differential Analysis

Perform a differential analysis for each PDCL in the database against the controls.

```{r run-deseq2, cache=TRUE, message=FALSE}
deseq2_res_list <- lapply(pdcl_names, function(pdcl){
  dataset_pdcl <- c(control_names, pdcl)
  # Subract a dataset which contains only the counts for the
  # current PDCL
  dataset <- count_data[,dataset_pdcl]
  # Same with metadata
  dataset_metadata <- count_metadata[ count_metadata$sample %in% dataset_pdcl, ]
  # Perform DESeq2 Analysis
  dds <- DESeqDataSetFromMatrix(
    countData = dataset, 
    colData = dataset_metadata, 
    design = ~condition
  )
  dds <- DESeq(dds)
  res <- results(dds, alpha = 0.05)
})
names(deseq2_res_list) <- pdcl_names
```

Save Result in rds file and write a csv file for each PDCL.

```{r save-deseq2}
saveRDS(deseq2_res_list, file = "deseq2_pdcl_vs_control.rds")
for (pdcl in pdcl_names){
  res <- deseq2_res_list[[pdcl]]
  res.file <- paste0("Result/deseq2/deseq2_", pdcl, ".csv")
  write.csv(as.data.frame(res), file = res.file)
}
```

# 2. GSEA Analysis for DESeq2 result

Load GMT files for GSEA pathway enrichment.

```{r create-gsea-gmt-list}
reactome_gmt_file <- gmtPathways("Data/gene-set/jorge-gmt/reactome_gmt_symbol_no_unwanted_categ_no_less_10.gmt")
gsea_gmt_list <- list(reactome = reactome_gmt_file)
```

Run GSEA for DESeq2 result

*Message from Jorge :*

We must choose a seed to ensure the analysis is reproducible. This is because GSEA uses a permutation test to span the null distribution of the statistic. Hence, each time we run it, results are expected to change slightly.

```{r run-gsea, cache=TRUE, message=FALSE}
set.seed(1)
# Create the ranked list for GSEA
rank_list <- lapply(deseq2_res_list, function(x){
  rnk <- x$log2FoldChange
  names(rnk) <- row.names(x)
  rnk
})
# Run GSEA analysis for each ranked list for both Reactom and Bioplanet
gsea_res_list <- lapply(rank_list, run.gsea, gsea_gmt_list)
saveRDS(gsea_res_list, file = "gsea_pathway_enrichment.rds")
gsea_gem <- lapply(gsea_res_list, convert.gsea.to.gem)
save.gem.list.to.txt(gsea_gem, "Result/gsea/deseq2/", "deseq2")
```

# 3. GProfiler Analysis for PENDA resuls

Upload GMT File before running G:Profiler Enrichment Analysis if needed.

```{r upload-gmt-gprofiler}
# This portion is commented because the file are already uploaded
# reactome_gmt_token <- upload_GMT_file(gmtfile = "Data/gene-set/jorge-gmt/reactome_gmt_symbol_no_unwanted_categ_no_less_10.gmt")
# bioplanet_gmt_token <- upload_GMT_file(gmtfile = "Data/gene-set/jorge-gmt/bioplanet_gmt_symbol_no_unwanted_categ_no_less_10.gmt")
```

Define GMT token to use for Enrichment Analysis

```{r define-gprofiler-gmt-token}
reactome_gmt_token <- "gp__Nqmx_yxm7_37U"
bioplanet_gmt_token <- "gp__vB7V_DT57_yNY"
```

Create a list of GMT files.

```{r create-gprofiler-gmt-list}
gprofiler_gmt_list <- list(reactome = reactome_gmt_token)
```

Load PENDA results

```{r load-penda}
penda_res_file <- "Data/PDCL/results_combine.csv"
penda_res <- read.table(penda_res_file, sep = ";", header = T, row.names = 1, check.names = F)
penda_pdcl_names <- names(penda_res)
# Remove ".genes.results" string in the column names
penda_pdcl_names <- sub(".genes.results", "", penda_pdcl_names, ignore.case = T)
names(penda_res) <- penda_pdcl_names
```

Run G:Profiler for PENDA result

```{r run-gprofiler, cache=TRUE, message=FALSE}
all_pdcl_genes <- row.names(penda_res)
gost_res_list <- lapply(penda_res, function(pdcl){
  gene_list <- all_pdcl_genes[pdcl != 0]
  res <- run.gost(
    gene_list,
    all_pdcl_genes,
    gprofiler_gmt_list
  )
  return(res)
})
```

Save Result in RDS and in Generic Enrichment Map (GEM) format

```{r save-gprofiler}
saveRDS(gost_res_list, file = "gprofiler_pathway_enrichment.rds")
gost_gem <- lapply(gost_res_list, convert.gost.to.gem)
save.gem.list.to.txt(gost_gem, "Result/gprofiler/penda/", "penda")
```

# 4. Analyze Result

## Collapse results

Here we collapse the result from GProfiler and GSEA into one data.frame so it is easier to plot graph with ggplot.

```{r collapse-results}
db_source <- ("reactome")

# Collapsed result into one dataframe.
# Each line contain the p_value and fdr of gprofiler and gsea for one pathway
# of one PDCL
collapsed_by_pathways <- collapse.data.by.pathways(
  gost_gem, 
  gsea_gem, 
  pdcl_names, 
  db_source
)
collapsed_by_pathways <- assign.categories(collapsed_by_pathways)

collapsed_by_pathways <- collapsed_by_pathways %>% 
  filter(!(undesired | is.na(category)))

collapsed_by_pathways$category <- factor(
  collapsed_by_pathways$category,
  levels = names(word_list)
)

collapsed_by_pathways$pdcl <- factor(
  collapsed_by_pathways$pdcl,
  levels = pdcl_names
)

# Collapse the results by method.
# One line contain the result of one enrichment method for one pathway of one PDCL
collapsed_by_method <- collapse.data.by.method(collapsed_by_pathways)
```

## Plot Results with alpha = 0.05

```{r threshold-5-percent}
threshold <- 0.05

# Find the pathway enriched in both GSEA and G:Profiler for each PDCL
common_pathway_0.05 <- find.common.pathways(collapsed_by_pathways, threshold)
all_result_0.05 <- collapsed_by_pathways %>% inner_join(common_pathway_0.05, by=c("pathway_id", "pdcl"))
all_result_by_method_0.05 <- collapsed_by_method %>% inner_join(common_pathway_0.05, by=c("pathway_id", "pdcl"))
result_by_method_0.05 <- all_result_by_method_0.05 %>% filter(fdr < threshold)
count_0.05 <- result_by_method_0.05 %>% dplyr::count(method, pdcl, category, .drop = F)
```

```{r gprofiler-vs-gsea-5-percent}
gprofiler_vs_gsea_0.05 <- plot.gprofiler.vs.gsea(all_result_0.05)
gprofiler_vs_gsea_0.05 
ggsave(
  "Result/result_0.05/plot_gprofiler_vs_gsea.png",
  plot = gprofiler_vs_gsea_0.05,
  width = 10,
  height = 7
)
```

```{r count-categories-5-percent}
count_categories_0.05 <- plot.count.categories(result_by_method_0.05)
count_categories_0.05 
ggsave(
  "Result/result_0.05/plot_count_categories.png",
  plot = count_categories_0.05,
  width = 10,
  height = 7
)
```

```{r count-pathways-5-percent}
count_pathways_0.05 <- plot.count.pathways(result_by_method_0.05)
count_pathways_0.05 
ggsave(
  "Result/result_0.05/plot_count_pathways.png",
  plot = count_pathways_0.05,
  width = 10,
  height = 7
)
```

```{r heatmap-pathways-5-percent, fig.width=12, fig.height=6}
heatmap_pathways_0.05 <- heatmap.pathways(all_result_by_method_0.05)
heatmap_pathways_0.05 
ggsave(
  "Result/result_0.05/heatmap_pathways.png",
  plot = heatmap_pathways_0.05,
  width = 12,
  height = 6
)
```

```{r heatmap-categories-5-percent, fig.width=16, fig.height=10}
heatmap_categories_0.05 <- heatmap.categories(count_0.05)
heatmap_categories_0.05 
ggsave(
  "Result/result_0.05/heatmap_categories.png",
  plot = heatmap_categories_0.05,
  width = 16,
  height = 10
)
```

## Plot Results with alpha = 0.1

```{r threshold-10-percent}
threshold <- 0.1

# Find the pathway enriched in both GSEA and G:Profiler for each PDCL
common_pathway_0.1 <- find.common.pathways(collapsed_by_pathways, threshold)
all_result_0.1 <- collapsed_by_pathways %>% inner_join(common_pathway_0.1, by=c("pathway_id", "pdcl"))
all_result_by_method_0.1 <- collapsed_by_method %>% inner_join(common_pathway_0.1, by=c("pathway_id", "pdcl"))
result_by_method_0.1 <- all_result_by_method_0.1 %>% filter(fdr < threshold)
count_0.1 <- result_by_method_0.1 %>% dplyr::count(method, pdcl, category, .drop = F)
```

```{r gprofiler-vs-gsea-10-percent}
gprofiler_vs_gsea_0.1 <- plot.gprofiler.vs.gsea(all_result_0.1)
gprofiler_vs_gsea_0.1 
ggsave(
  "Result/result_0.1/plot_gprofiler_vs_gsea.png",
  plot = gprofiler_vs_gsea_0.1,
  width = 10,
  height = 7
)
```

```{r count-categories-10-percent}
count_categories_0.1 <- plot.count.categories(result_by_method_0.1)
count_categories_0.1 
ggsave(
  "Result/result_0.1/plot_count_categories.png",
  plot = count_categories_0.1,
  width = 10,
  height = 7
)
```

```{r countt-pathways-10-percent}
count_pathways_0.1 <- plot.count.pathways(result_by_method_0.1)
count_pathways_0.1 
ggsave(
  "Result/result_0.1/plot_count_pathways.png",
  plot = count_pathways_0.1,
  width = 10,
  height = 7
)
```

```{r heatmap-pathways, fig.width=16, fig.height=14}
heatmap_pathways_0.1 <- heatmap.pathways(all_result_by_method_0.1)
heatmap_pathways_0.1 
ggsave(
  "Result/result_0.1/heatmap_pathways.png",
  plot = heatmap_pathways_0.1,
  width = 16,
  height = 14
)
```

```{r heatmap-categories-10-percent, fig.width=16, fig.height=10}
heatmap_categories_0.1 <- heatmap.categories(count_0.1)
heatmap_categories_0.1 
ggsave(
  "Result/result_0.1/heatmap_categories.png",
  plot = heatmap_categories_0.1,
  width = 16,
  height = 10
)
```
