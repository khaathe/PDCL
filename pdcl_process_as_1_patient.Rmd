---
title: "pdcl_process_as_1_patient"
output:
  html_document:
    toc: yes
    toc_float: true
    number_sections: true
    toc_depth: 3
    highlight: kate
    fig_width: 10
    fig_heigth: 7
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls() )

# Load required libraries (others are load directly in sourced files)
library(DESeq2)
library(dplyr)
library(purrr)
library(plotly)

# Source files with functions used in next steps
source("R/gprofiler-analysis.R")
source("R/gsea-analysis.R")
source("R/plot-result.R")

# Constant
result_dir <- "~/PhD/PDCL/Result_pdcl_process_as_1_patient/"
```

# Load Data

## Load controls

```{r load-controls}
control_file <- "Data/PDCL/astrocyte_GSE109001_counts_unique_genes_samples_filtered.txt"
control <- read.table(
  control_file, 
  header = T, 
  sep = "\t", 
  as.is = c("id", "symbol")
)
control_names <- c(
  "AF22_NES_Astro_Br1_d29_37_S46",
  "AF22_NES_Astro_Br2_d29_38_S56",
  "AF22_NES_Astro_Br3_d29_39_S66",
  "CCF.STTG1_p24_Br1_S16",
  "CCF.STTG1_p24_Br2_S17",
  "CCF.STTG1_p24_Br3_S18",
  "CDIAstrocytes_p2_Br1_S19",
  "CDIAstrocytes_p2_Br2_S20",
  "CDIAstrocytes_p2_Br3_S21",
  "phaAstrocyte_p2_Br1_S1",
  "phaAstrocyte_p2_Br2_S2",
  "phaAstrocyte_p2_Br3_S3"
  )
```

## Load PDCL DataBase

Load the PDCL count table. Disabled check.names otherwise it will add a X at the beginning of each column name, as column names aren't valid according to R.

```{r load-pdcl}
pdcl_count_table <- read.table(
  "/home/spinicck/PhD/Data/PDCL/lignees_count_genes_PDCL.txt", 
  sep = "\t", 
  header = T, 
  as.is = "gene_id", 
  check.names = F
)

pdcl_names <- c(
  "4339-p21",
  "4371-p37",
  "5706-p14",
  "6190-p43",
  "6240-p12",
  "7015-p17",
  "7060-p18", 
  "7142-p14",
  "N13-1300",
  "N13-1520-p9",
  "N14-0072",
  "N14-0870",
  "N14-1208",
  "N14-1525",
  "N15_0460",
  "N15_0516",
  "N15-0385",
  "N15-0661",
  "N16_0535",
  "N16-0240"
)
```


## Load PENDA results

```{r load-penda}
penda_res <- readRDS("Data/PDCL/results_penda_astrocytes_2021.rds")
penda_res <- as.data.frame(penda_res)
penda_pdcl_names <- names(penda_res)
# Remove ".genes.results" string in the column names
penda_pdcl_names <- sub(".genes.results", "", penda_pdcl_names, ignore.case = T)
names(penda_res) <- penda_pdcl_names
```

## Load GSEA GMTs

Load GMT files for GSEA pathway enrichment.

```{r create-gsea-gmt-list}
reactome_gmt_file <- gmtPathways(
  "Data/gene-set/jorge-gmt/reactome_gmt_symbol_no_unwanted_categ_no_less_10.gmt"
)
gsea_gmt_list <- list(reactome = reactome_gmt_file)
```

## Load G:Profiler GMTs

Upload GMT File before running G:Profiler Enrichment Analysis if needed.

Otherwise juste define the token of the GMT stored on G:Profiler website.

```{r upload-gmt-gprofiler}
# This portion is commented because the file are already uploaded
# reactome_gmt_token <- upload_GMT_file(gmtfile = 
#  "Data/gene-set/jorge-gmt/reactome_gmt_symbol_no_unwanted_categ_no_less_10.gmt"
# )
# bioplanet_gmt_token <- upload_GMT_file(gmtfile = 
#  "Data/gene-set/jorge-gmt/bioplanet_gmt_symbol_no_unwanted_categ_no_less_10.gmt"
# )

reactome_gmt_token <- "gp__Nqmx_yxm7_37U"
bioplanet_gmt_token <- "gp__vB7V_DT57_yNY"
```

Create a list of GMT files.

```{r create-gprofiler-gmt-list}
gprofiler_gmt_list <- list(reactome = reactome_gmt_token)
```

# Differential Analysis with DESeq2

## Prepare Object needed by DESeq2 for Analysis

Create two data.frame:

-   count_data : contain the raw counts of each genes for both control and PDCL samples
-   count_metadata : metadata for associated with the samples to know which samples belong to the controls and which belong to the PDCL

```{r prepare-count-data}
# Merge control and PDCL counts into one dataframe
count_data <- merge(control, pdcl_count_table, by.x = "symbol", by.y = "gene_id")
# Associate each row with a gene symbol
row.names(count_data) <- count_data$symbol
# Remove symbol and id columns
count_data <- count_data %>% dplyr::select(!c(symbol, id))
condition_vect <- c(
  rep("control", length(control_names)), 
  rep("pdcl", length(pdcl_names))
)
sample <- gsub("^(.*)_(Br\\d.*)", "\\1", colnames(count_data), ignore.case = T, perl = T, fixed = F)
# sample[(length(control_names)+1):length(sample)] <- "gbm"
replicate <- gsub("^(.*)_(Br\\d.*)", "\\2", colnames(count_data), ignore.case = T, perl = T, fixed = F)
count_metadata <- data.frame(
  sample = as.factor(sample),
  replicate = as.factor(replicate),
  condition = as.factor(condition_vect),
  row.names = colnames(count_data)
)
```

## Perform Differential Analysis

Perform a differential analysis for each PDCL in the database against the controls 
and save the result in rds file and a csv file.

```{r run-deseq2, cache=TRUE}
alpha <- 0.05
dds <- DESeqDataSetFromMatrix(
  countData = count_data, 
  colData = count_metadata, 
  design = ~condition
)
dds <- DESeq(dds)
deseq2_res <- results(dds, alpha = alpha, contrast = c("condition", "pdcl", "control"))

saveRDS(deseq2_res, file = paste0(result_dir, "deseq2_pdcl_vs_control.rds"))
write.csv(as.data.frame(deseq2_res), file = paste0(result_dir, "deseq2/deseq2_1_patient.csv"))

deregulated_index <- which(deseq2_res$padj <= alpha)
deregulated_genes <- row.names(deseq2_res)[deregulated_index]

summary(deseq2_res)
```

## VolcanoPlot Differential Analysis Results

```{r volcano-plot-deseq2, echo=FALSE}
deseq2_res_df <- as.data.frame(deseq2_res)
ggplot(
  deseq2_res_df, 
  aes(x = log2FoldChange, y = -log10(padj), colour = (padj<alpha) )
) + 
  geom_point() +
  scale_color_manual(values = c("TRUE" = "red"), labels = c("Deregulated")) +
  labs(
    title = "Volcano Plot DESeq2 Results",
    colour = NULL
  )
```

## Compare DESeq2_log2FC with manually computed log2FC

```{r compare-lfc}
pdcl_mean_expr <- rowMeans(pdcl_count_table[,-1])
names(pdcl_mean_expr) <- pdcl_count_table$gene_id
control_mean_expr <- rowMeans(control[,c(-1,-2)])
names(control_mean_expr) <- control$symbol
pdcl_genes <- pdcl_count_table$gene_id[ pdcl_count_table$gene_id %in% control$symbol]
pdcl_mean_expr <- pdcl_mean_expr[pdcl_genes]
control_mean_expr <- control_mean_expr[pdcl_genes]
log2FC <- log2(pdcl_mean_expr/control_mean_expr)
names(log2FC) <- pdcl_genes

deseq2_FC <- deseq2_res$log2FoldChange
names(deseq2_FC) <- row.names(deseq2_res)
deseq2_FC <- deseq2_FC[pdcl_genes]

data <- data.frame(log2FC = log2FC, deseq2_FC = deseq2_FC)
data <- data %>% filter(!is.infinite(log2FC), !is.nan(log2FC), !is.infinite(deseq2_FC), !is.nan(deseq2_FC) )
fit <- lm(formula = deseq2_FC ~ log2FC, data = data)

p_comparison_log2fc <- ggplot(
  data,
  aes(x = log2FC, y = deseq2_FC)
) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  geom_abline(slope = fit$coefficients[2], intercept = fit$coefficients[1], color = "blue") +
  labs(title = "Comparison log2FoldChange", x = "log2FC manually computed", y = "log2FC computed by DESeq2")

ggplotly(p_comparison_log2fc)
```

# Pathways Enrichment

## GSEA Pathway Enrichment

Here we run a GSEA pathway enrichment analysis with the log2FoldChange calculated by DESeq2 as the scoring metrics in the ranked list submited to GSEA.

*Message from Jorge :*

We must choose a seed to ensure the analysis is reproducible. This is because GSEA uses a permutation test to span the null distribution of the statistic. Hence, each time we run it, results are expected to change slightly.

```{r run-gsea, cache=TRUE}
set.seed(1)
# Create the ranked list for GSEA
rnk_tmp <- as.data.frame(deseq2_res) %>%
  drop_na() %>%
  filter(padj < alpha) %>%
  mutate(rank = log2FoldChange*-log10(padj)) %>%
  arrange(desc(rank))
rnk <- rnk_tmp %>% pull(rank)
names(rnk) <- row.names(rnk_tmp)
rnk <- rnk[is.finite(rnk)]
rank_list <- list("gbm" = rnk)

# Run GSEA analysis for each ranked list for both Reactom and Bioplanet
gsea_res_list <- lapply(rank_list, run.gsea, gsea_gmt_list)
saveRDS(gsea_res_list, file = paste0(result_dir, "gsea_pathway_enrichment.rds"))

gsea_gem <- lapply(gsea_res_list, convert.gsea.to.gem)
save.gem.list.to.txt(gsea_gem, paste0(result_dir, "gsea/deseq2/"), "deseq2")
```

## GProfiler Pathway Enrichment

Run G:Profiler

```{r run-gprofiler, cache=TRUE}
all_pdcl_genes <- row.names(deseq2_res)
all_gene_list <- list("gbm" = deregulated_genes)
gost_res_list <- lapply(all_gene_list, function(gene_list){
  res <- run.gost(
    gene_list,
    all_pdcl_genes,
    gprofiler_gmt_list
  )
  return(res)
})
```

Save Result in RDS and in Generic Enrichment Map (GEM) format

```{r save-gprofiler}
saveRDS(gost_res_list, file = paste0(result_dir, "gprofiler_pathway_enrichment.rds"))
gost_gem <- lapply(gost_res_list, convert.gost.to.gem)
save.gem.list.to.txt(gost_gem, paste0(result_dir, "gprofiler/deseq2/"), "deseq2")
```

## Process Result

### Define GEM list

```{r define-gem-list}
gem_list <- list("G:Profiler" = gost_gem, "GSEA" = gsea_gem)
```

### Collapse by method

```{r collapse-by-method}
# Collapse the results by method.
# One line contain the result of one enrichment method for one pathway of one PDCL
gem_collapsed <- collapse.gem.list(gem_list)
```

### Collapse by pathways

```{r collapse-by-pathways}
gem_collapsed_method_vs_method <- collapse.method.vs.method(gem_collapsed)
```

### Find common pathways

```{r find-common-pathways}
all_common_pathways <- find.method.common.pathways(gem_collapsed_method_vs_method, c(0.05, 0.1))
gem_collapsed_method_vs_method <- gem_collapsed_method_vs_method %>%
  inner_join(all_common_pathways, by=c("pathway_id", "pdcl", "method_1", "method_2"))
all_common_pathways %>% dplyr::count(alpha_0.1)
```

## Plot 

```{r set-alpha, include=FALSE}
threshold <- 0.1
plot_comp_method_dir <- paste0(result_dir, "plot/alpha_0.05/comparison_method/")
count_dir <- paste0(result_dir, "plot/alpha_0.05/count/")
heatmap_dir <- paste0(result_dir, "plot/alpha_0.05/heatmap/")
```

### Plot count categories 

```{r count-categories-10-percent}
count_categories_0.1 <- plot.count.categories(gem_collapsed, threshold)
tmp_filename <- paste0(count_dir, "plot_count_categories_0.1.png")
ggsave(tmp_filename, plot = count_categories_0.1, width = 10, height = 7)
count_categories_0.1
```

# Pathway Enrichment for Super Deregulated Genes

## Analyze Deregulated genes

```{r select-categories, echo=FALSE}
all_pathways <- gmtPathways("Data/gene-set/jorge-gmt/reactome_gmt_symbol.gmt")
all_pathway_names <- names(all_pathways)

categories_re <- c(
  "^\\bAutophagy\\b$",
  "^\\bCell Cycle\\b$",
  "^\\bCell-Cell communication\\b$",
  "^\\bCellular responses to external stimuli\\b$",
  "^\\bChromatin organization\\b$",
  "^\\bCircadian Clock\\b$",
  "^\\bDNA Repair\\b$",
  "^\\bDNA Replication\\b$",
  "^\\bExtracellular matrix organization\\b$",
  "^\\bGene expression",
  "^\\bMetabolism\\b$",
  "^\\bMetabolism of proteins\\b$",
  "^\\bMetabolism of RNA\\b$",
  "^\\bOrganelle biogenesis and maintenance\\b$",
  "^\\bProgrammed Cell Death\\b$",
  "^\\bProtein localization\\b$",
  "^\\bVesicle-mediated transport\\b$",
  "^\\bSignal Transduction\\b$"
)

pattern <- paste0(categories_re, collapse = "|")
match_index <- grepl(pattern, all_pathway_names, ignore.case = T, perl = T)
categories <- all_pathways[match_index]
# To see the number of genes present in the GMT file
# lapply(categories, function(x){ length(x) })
```

Number of deregulated genes per categories :

```{r table-pdcl-categories , echo=FALSE}
penda_genes <- row.names(penda_res)
pdcl_dereg_genes <- imap_dfr(penda_res, function(x, y){
  dereg_index <- which(x != 0)
  data.frame(gene = penda_genes[dereg_index], dereg = x[dereg_index], pdcl = y)
})

category_genes <- imap_dfr(categories, function(x, y){
  data.frame(category = y, gene = x)
})

pdcl_dereg_categories <- pdcl_dereg_genes %>% inner_join(category_genes, by = "gene")
table_pdcl_dereg_categories <- table( select(pdcl_dereg_categories, category, pdcl) )
table_pdcl_dereg_categories <- as.data.frame(table_pdcl_dereg_categories)

h_dereg_categ <- ggplot(
  table_pdcl_dereg_categories,
  aes(pdcl, category, fill = Freq)
) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90))

ggplotly(h_dereg_categ)
```

## Find Super Deregulated genes
Number of super-deregulated genes (deregulated accross all the PDCL):

```{r super-deregulated-genes, echo=FALSE}
super_deregulated_genes <- pdcl_dereg_genes %>%
  count(gene, dereg) %>%
  filter(n==length(pdcl_names)) %>%
  arrange(gene) %>% 
  select(gene, dereg)

table(super_deregulated_genes$dereg)
```

```{r plot-sd-genes-lfc}
deseq2_res_df$sd_dereg <- 0
sd_index <- which(row.names(deseq2_res_df) %in% super_deregulated_genes$gene)
keep <- row.names(deseq2_res_df)[sd_index]
deseq2_res_df$sd_dereg[sd_index] <- super_deregulated_genes$dereg[super_deregulated_genes$gene %in% keep]
deseq2_res_df$sd_dereg <- as.factor(deseq2_res_df$sd_dereg)
data <- deseq2_res_df # %>% filter(sd_dereg != "0")
data$gene <- row.names(data)
volcano_sd_genes_lfc <- ggplot(
  data,
  aes(x = log2FoldChange, y = -log10(padj), colour = sd_dereg, alpha = 0.6, label = gene)
) + 
  geom_point() +
  scale_color_manual(values = c("1" = "red", "-1" = "blue"), labels = c("Super Up", "Super Down")) +
  labs(
    title = "Volcano Plot DESeq2 Results",
    colour = NULL
  )

volcano_sd_genes_lfc
```

## GSEA Pathway Enrichment

Here we run a GSEA pathway enrichment analysis with the log2FoldChange calculated by DESeq2 as the scoring metrics in the ranked list submited to GSEA.

*Message from Jorge :*

We must choose a seed to ensure the analysis is reproducible. This is because GSEA uses a permutation test to span the null distribution of the statistic. Hence, each time we run it, results are expected to change slightly.

```{r run-gsea-sd, cache=TRUE}
set.seed(1)
# Create the ranked list for GSEA
keep <- super_deregulated_genes$gene[super_deregulated_genes$gene %in% row.names(deseq2_res)]

rnk_tmp <- as.data.frame(deseq2_res[keep,]) %>%
  mutate(rank = log2FoldChange*-log10(padj)) %>%
  arrange(desc(rank))
rnk <- rnk_tmp %>% pull(rank)
names(rnk) <- row.names(rnk_tmp)
rnk <- rnk[is.finite(rnk)]
rank_sd_list <- list("super_deregulated" = rnk)

# Run GSEA analysis for each ranked list for both Reactom and Bioplanet
gsea_res_sd_list <- lapply(rank_sd_list, run.gsea, gsea_gmt_list)
saveRDS(gsea_res_sd_list, file = paste0(result_dir, "gsea_sd_ pathway_enrichment.rds"))

gsea_sd_gem <- lapply(gsea_res_sd_list, convert.gsea.to.gem)
save.gem.list.to.txt(gsea_sd_gem, paste0(result_dir, "gsea_sd/deseq2/"), "deseq2")
```

## GProfiler Pathway Enrichment

Run G:Profiler

```{r run-gprofiler-sd, cache=TRUE}
all_pdcl_genes <- row.names(deseq2_res)
all_sd_gene_list <- list("superderegulated" = deregulated_genes)
gost_sd_res_list <- lapply(all_sd_gene_list, function(gene_list){
  res <- run.gost(
    gene_list,
    all_pdcl_genes,
    gprofiler_gmt_list
  )
  return(res)
})

saveRDS(gost_sd_res_list, file = paste0(result_dir, "gprofiler_sd_pathway_enrichment.rds"))
gost_sd_gem <- lapply(gost_sd_res_list, convert.gost.to.gem)
save.gem.list.to.txt(gost_sd_gem, paste0(result_dir, "gprofiler_sd/deseq2/"), "deseq2")
```

## Process Result

### Define GEM list

GSEA gives no result for pathway enrichment on SuperDeregulated genes. Hence we
do not add it to the gem list to study.
```{r define-sd-gem-list}
gem_sd_list <- list("G:Profiler" = gost_sd_gem)
```

### Collapse by method

```{r collapse-sd-by-method}
# Collapse the results by method.
# One line contain the result of one enrichment method for one pathway of one PDCL
gem_sd_collapsed <- collapse.gem.list(gem_sd_list)
```

## Plot

```{r save-session, include=FALSE}
save.image("~/PhD/PDCL/pdcl_process_as_1_patient.RData")
```

